---
layout: post
title: "Setting up RPMsg"
categories: GSoC
---

This post explains how to run TI's lab_5 on the BBB, without using the Code Composer Studio.
RPMsg is a little tricky to get started with so I recommend following these steps: 

1. SSH into the BeagleBone Black.
2. Some tasks need you to be the root user, so login as root or use `sudo` if you get `permission denied` error.
3. `$ uname -r` to verify kernel -> mine at the moment is _4.14.71-ti-r80_
4. `$ sudo apt-get update`.
5. cd / and then find clpru compiler which is generally in /usr/share/ti/cgt-pru. This is the location of the PRU code generation tools - compiler.
6. On doing this:  
```
$ which clpru
/usr/bin/clpru
``` 
So the compiler binary is in a different location. This is a problem for labs to make files.<br>
```
$ cd /usr/share/ti/cgt-pru
$ mkdir bin
$ ln -s /usr/bin/clpru clpru
```
So now the make files will find the compiler executable in the correct location via the symbolic link.
7. Make sure all the modules are loaded.<br>
```
$ sudo modprobe pru_rproc
$ sudo modprobe rpmsg_pru
$ sudo modprobe virtio_rpmsg_bus
```
8. `$ cd ~`<br>
`$ git clone [git://git.ti.com/pru-software-support-package/pru-software-support-package.git](git://git.ti.com/pru-software-support-package/pru-software-support-package.git)`<br>
This will clone a copy of the latest pru-software-support-package: The ones used in TI's Hands On Training Labs.
9. cd into _lab_5_ in the package:
```
$ cd lab_5/solution/PRU_Halt
$ make
```
This will fail, it is looking for the environment variable $PRU_CGT
`$ export PRU_CGT=/usr/share/ti/cgt-pru`
Now try _make_ again. It should succeed.<br>

10. Do (for **pru0**)
```
$ cd gen
$ sudo cp PRU_Halt.out am335x-pru0-fw
$ sudo cp am335x-pru0-fw /lib/firmware
```

11. Now cd into the PRU_RPMsg_Echo_Interrupt1 directory in the same lab_5.<br>
Edit main.c as follows:
```
//#define CHAN_NAME					"rpmsg-client-sample"
#define CHAN_NAME					"rpmsg-pru"
```
(Comment, Uncomment)

12. Now almost the same as #10, this time for **pru1**:
```
$ cd gen
$ cp PRU_RPMsg_Echo_Interrupt1.out am335x-pru1-fw
$ cp am335x-pru1-fw /lib/firmware
```

13. Reboot, Start the second PRU i.e. pru1
`$ echo start | sudo tee /sys/class/remoteproc/remoteproc2/state`<br>

14. _cd /dev_ look for _rpmsg_pru31_ device file.  It will be there!

Hopefully I did not miss any of the steps.  Let me know if any changes are needed.
